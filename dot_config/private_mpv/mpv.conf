# =================================================================================================
# 基础设置 (General)
# =================================================================================================
profile=high-quality
vo=gpu-next                            # 现代化的渲染器，推荐用于 HDR 和新特性
gpu-api=vulkan                         # Vulkan 在 gpu-next 下表现最好，若有 bug 可改为 d3d11 (Windows) 或 opengl
fullscreen=yes
keep-open=always
reset-on-next-file=pause
save-position-on-quit=yes
auto-window-resize=yes
taskbar-progress=no
force-seekable=yes
hr-seek=yes                            # 允许精确的一帧一帧的跳转，即使是非关键帧

# =================================================================================================
# 视频与画质 (Video & Quality)
# =================================================================================================
hwdec=auto-safe                        # 优化：由 no 改为 auto-safe，在不降低画质的前提下尽可能使用硬解以省电
dither-depth=auto

# 缩放算法 (Scaling)
# ewa_lanczossharp 容易产生振铃 (ringing)，改为更平衡的 ewa_lanczos 或 spline36
scale=ewa_lanczos
scale-antiring=0.6
# 色度升降频：CfL 着色器生效时此项会被覆盖，但作为保底设置，catmull_rom 比 ewa_lanczossharp 效率更高且肉眼难以区分
cscale=catmull_rom
dscale=mitchell

# 去色带 (Debanding) - 默认关闭，由 Profile 动态启用
deband=no
deband-iterations=2
deband-threshold=48                    # 过高可能会抹除细节
deband-range=16
deband-grain=32                        # 增加颗粒感以掩盖色带

# 缓存与着色器缓存
gpu-shader-cache-dir='~~/shaders/cache'
demuxer-max-bytes=2048MiB
demuxer-readahead-secs=300

# =================================================================================================
# 插帧与同步 (Interpolation / Motion)
# =================================================================================================
video-sync=display-resample            # 配合插帧必须开启
interpolation=yes
tscale=mitchell

# =================================================================================================
# OSD / 界面
# =================================================================================================
osc=no                                 # 禁用了自带 OSC
border=no

osd-bar=no
cursor-autohide-fs-only=yes
cursor-autohide=1000
osd-level=1
osd-duration=2000
osd-font='Verdana'
osd-font-size=24                       # 微调大小
osd-color='#FFFFFF'
osd-border-color='#000000'
osd-border-size=1.2                    # 稍微加粗边框提高在高亮背景下的可读性
osd-blur=0.2

# =================================================================================================
# 音频与字幕 (Audio & Subtitles)
# =================================================================================================
alang=ja,jp,jpn,en,eng,zh,cmn,chi
slang=zh,cmn,chi,zh-CN,sc,chs,en,eng
volume=100
volume-max=150                         # 过高会爆音
audio-channels=auto-safe               # 优化：从 stereo 改为 auto-safe，避免强制立体声导致多声道源丢失信息
audio-pitch-correction=yes
sub-auto=fuzzy
sub-font='Netflix Sans Medium'
sub-font-size=45
sub-border-size=2.0
sub-shadow-offset=1                    # 加一点阴影增加层次感
blend-subtitles=yes

# =================================================================================================
# 截图 (Screenshots)
# =================================================================================================
screenshot-format=png
screenshot-high-bit-depth=yes
screenshot-png-compression=4           # 压缩率影响文件大小
screenshot-directory="~/tmp/mpv-screenshots"
screenshot-template="%f-%wH.%wM.%wS.%wT-#%#00n"

# =================================================================================================
# 协议处理 (Protocols)
# =================================================================================================
[protocol.http]
hls-bitrate=max
cache=yes
no-cache-pause

[protocol.https]
profile=protocol.http

[protocol.ytdl]
profile=protocol.http

# =================================================================================================
# 自动配置文件 (Profiles)
# =================================================================================================

[WEB-DL]
profile-desc=WEB-DL Anime
profile-cond=string.match(p.filename, "HatSubs")~=nil or string.match(p.filename, "SubsPlease")~=nil or string.match(p.filename, "HorribleSubs")~=nil or string.match(p.filename, "Erai%-raws")~=nil
deband=yes

[hdr-direct]
profile-desc=HDR Passthrough/Tone mapping
profile-cond=p["video-params/sig-peak"]>1 and p["video-params/gamma"]=="pq"
profile-restore=copy
target-peak=auto                       # gpu-next 下 auto 效果通常比固定 1000nit 好
tone-mapping=spline                    # 推荐的色调映射算法
target-contrast=auto                   # 除非你是 OLED 且在全黑屋，否则 auto 比 inf 更好
target-colorspace-hint=yes

# --- 分辨率与帧率自动判定 ---
# 1. 亮度（Luma）超分辨率放大
# 2. 色度（Chroma）修复/放大
# 3. 去色带与抗噪（Deband & Denoise）

[4k60]
profile-desc=4k60
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]>=31)
deband=no
interpolation=no
# 4K 源通常不需要 Luma 放大，只需要 Chroma 处理
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[4k30]
profile-desc=4k30
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]<31)
deband=no
# 此时 mpv 全局开启了插帧，这里不禁用即可
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd60]
profile-desc=full-hd60
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]>=31)
interpolation=no
deband=yes                             # 1080p 源通常会有色带，建议开启
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd30]
profile-desc=full-hd30
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
deband=yes
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[full-hd-interlaced]
profile-desc=full-hd-interlaced
profile-cond=((width ==1920 and height ==1080) and p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ArtCNN_C4F16.glsl"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[hd]
profile-desc=hd-720p
profile-cond=(width ==1280 and height ==720)
interpolation=no
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[sdtv-ntsc]
profile-desc=sdtv-ntsc
profile-cond=((width ==640 and height ==480) or (width ==704 and height ==480) or (width ==720 and height ==480))
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[sdtv-pal]
profile-desc=sdtv-pal
profile-cond=((width ==352 and height ==576) or (width ==480 and height ==576) or (width ==544 and height ==576) or (width ==720 and height ==576))
deinterlace=yes
deband=yes
glsl-shader="~~/shaders/ravu-zoom-ar-r3.hook"
glsl-shader="~~/shaders/CfL_Prediction.glsl"

[Manga]
profile-desc="Read Manga"
profile-cond=filename and (filename:match('%.cbz$') or filename:match('%.cbr$') or filename:match('%.zip$') or filename:match('%.rar$'))
profile=high-quality
dscale=mitchell
deband=no

